{"config":{"lang":["en"],"separator":"[\\s\\-]+","pipeline":["stopWordFilter"],"fields":{"title":{"boost":1000.0},"text":{"boost":1.0},"tags":{"boost":1000000.0}}},"docs":[{"location":"","title":"CafeSentinel - Technical Documentation","text":""},{"location":"#overview","title":"Overview","text":"<p>CafeSentinel is a network monitoring and occupancy tracking application for internet cafes. It monitors network infrastructure (router, server, internet gateway), tracks client PC activity, captures screenshots, and sends notifications to Discord channels.</p> <p>The application uses a dual-process self-healing architecture where two executables monitor each other and automatically restart on failure. All sensitive configuration and credential data is encrypted and stored in disguised file formats for security.</p>"},{"location":"#architecture","title":"Architecture","text":""},{"location":"#dual-process-system","title":"Dual-Process System","text":"<pre><code>CafeSentinel.exe (Main Application)\n\u251c\u2500 PySide6 GUI (system tray + main window)\n\u251c\u2500 Network monitoring worker thread\n\u251c\u2500 Screenshot capture service\n\u251c\u2500 Discord notification service\n\u251c\u2500 Flask REST API server (port 5000)\n\u2514\u2500 Monitors SentinelService.exe (5-second heartbeat)\n\nSentinelService.exe (Watchdog)\n\u251c\u2500 Monitors CafeSentinel.exe process\n\u251c\u2500 Restarts main app on crash/termination\n\u251c\u2500 Logs lifecycle events to info.log\n\u2514\u2500 Runs with elevated privileges\n</code></pre>"},{"location":"#mutual-monitoring","title":"Mutual Monitoring","text":"<ul> <li>Each process checks if the other is running every 5 seconds</li> <li>If either process terminates, the other restarts it within 2 seconds</li> <li>Only stoppable via password-protected shutdown from main app</li> <li>Uses process name detection via Windows tasklist command</li> </ul>"},{"location":"#security-layer","title":"Security Layer","text":"<ul> <li>Configuration stored encrypted as <code>cscf.dll</code> (not plaintext JSON)</li> <li>Passwords stored encrypted as <code>cron.dll</code> </li> <li>Encryption uses machine-specific keys derived from hardware fingerprint</li> <li>Log files sanitized to prevent revealing internal file structure</li> <li>All sensitive files disguised with .dll extension to avoid casual inspection</li> </ul>"},{"location":"#project-structure","title":"Project Structure","text":"<pre><code>CafeSentinel/\n\u251c\u2500\u2500 controllers/\n\u2502   \u2514\u2500\u2500 system_tray_app.py           # System tray controller, starts all services\n\u251c\u2500\u2500 models/\n\u2502   \u251c\u2500\u2500 app_logger.py                # Daily rotating log system with retention\n\u2502   \u251c\u2500\u2500 config_manager.py            # Encrypted config singleton manager\n\u2502   \u251c\u2500\u2500 discord_notifier.py          # Discord webhook client\n\u2502   \u251c\u2500\u2500 event_logger.py              # CSV incident logging\n\u2502   \u251c\u2500\u2500 network_tools.py             # ICMP ping implementation\n\u2502   \u251c\u2500\u2500 screen_capture.py            # Screenshot capture (mss library)\n\u2502   \u251c\u2500\u2500 security_manager.py          # Password vault with Fernet encryption\n\u2502   \u251c\u2500\u2500 sentinel_worker.py           # Main monitoring worker thread\n\u2502   \u2514\u2500\u2500 session_manager.py           # PC occupancy tracking\n\u251c\u2500\u2500 utils/\n\u2502   \u2514\u2500\u2500 resource_manager.py          # Path resolution for compiled/script mode\n\u251c\u2500\u2500 views/\n\u2502   \u251c\u2500\u2500 main_window.py               # GUI dashboard\n\u2502   \u251c\u2500\u2500 setup_wizard.py              # First-run password setup\n\u2502   \u251c\u2500\u2500 settings_dialog.py           # Local configuration editor\n\u2502   \u2514\u2500\u2500 settings_pages/\n\u2502       \u251c\u2500\u2500 network_page.py          # Network settings tab\n\u2502       \u251c\u2500\u2500 monitoring_page.py       # Monitoring settings tab\n\u2502       \u251c\u2500\u2500 discord_page.py          # Discord settings tab\n\u2502       \u2514\u2500\u2500 system_page.py           # System settings tab (log retention)\n\u251c\u2500\u2500 assets/icons/                    # Icon resources\n\u251c\u2500\u2500 api_server.py                    # Flask REST API server\n\u251c\u2500\u2500 interface.py                     # Main application entry point\n\u251c\u2500\u2500 watchdog_service.py              # Watchdog process entry point\n\u251c\u2500\u2500 startup_manager.py               # Windows startup registration\n\u251c\u2500\u2500 resources.qrc                    # Qt resource file\n\u251c\u2500\u2500 build.py                         # Nuitka build script\n\u251c\u2500\u2500 cscf.dll                         # Encrypted configuration (auto-generated)\n\u251c\u2500\u2500 cron.dll                         # Encrypted password vault (first-run)\n\u251c\u2500\u2500 info.log                         # Current day log file\n\u251c\u2500\u2500 probes/                          # Archived log files folder\n\u2514\u2500\u2500 config_backups/                  # Encrypted config backup folder\n</code></pre>"},{"location":"#technical-stack","title":"Technical Stack","text":"<ul> <li>GUI Framework: PySide6 (Qt for Python)</li> <li>Network Monitoring: Raw ICMP sockets (requires admin privileges)</li> <li>Screenshot Capture: mss library, output as WebP format</li> <li>HTTP Server: Flask with CORS support (REST API for remote management)</li> <li>Encryption: cryptography library (Fernet symmetric encryption)</li> <li>Notifications: Discord webhooks via requests library</li> <li>Compilation: Nuitka with optional LTO optimization</li> <li>Platform: Windows only (uses Windows-specific process management)</li> </ul>"},{"location":"#documentation-contents","title":"Documentation Contents","text":"<ul> <li>Monitoring System - SentinelWorker, Network Monitoring, PC Tracking</li> <li>Configuration System - File Structure, Schema, API, Hot-Reload</li> <li>Security System - Encryption, Password Management, Admin Requirements</li> <li>Logging System - Architecture, Rotation, Format, API Serving</li> <li>Features &amp; UI - Screenshots, Discord Integration, Settings Dialog</li> <li>Deployment &amp; Build - Compilation, Startup Registration, Dependencies</li> </ul>"},{"location":"configuration/","title":"Configuration System","text":""},{"location":"configuration/#core-components","title":"Core Components","text":""},{"location":"configuration/#configmanager-modelsconfig_managerpy","title":"ConfigManager (models/config_manager.py)","text":"<p>Singleton class that manages all configuration access with encryption and thread-safety.</p> <p>Architecture: - Singleton pattern ensures single config instance across application - Thread-safe operations using threading.Lock - Emits Qt signal when config changes for same-thread listeners - Uses dirty flag for cross-thread polling (worker thread compatibility)</p> <p>File Handling: - Primary config: <code>cscf.dll</code> (encrypted with Fernet) - Legacy support: migrates old <code>config.json</code> to encrypted format on first detection - Backup system: creates timestamped encrypted backups before updates - Keeps last 10 backups, auto-deletes older files</p> <p>Encryption: - Uses machine-specific key generated from hardware fingerprint - Fernet symmetric encryption (AES-128 in CBC mode with timestamp) - Config stored as encrypted JSON string - Decryption happens in-memory only, never written as plaintext</p> <p>Hot-Reload Support: - Exposes <code>check_and_clear_dirty()</code> method for worker thread polling - Emits <code>sig_config_changed</code> signal for same-thread GUI updates - Updates take effect immediately without file system monitoring</p>"},{"location":"configuration/#flask-api-server-api_serverpy","title":"Flask API Server (api_server.py)","text":"<p>REST API server for remote configuration management and log access.</p> <p>Server Configuration: - Runs in daemon thread (terminates with main application) - Binds to 0.0.0.0:5000 (accessible from network) - CORS enabled for cross-origin requests - Thread-safe config access via ConfigManager singleton</p> <p>Endpoint Reference:</p> Endpoint Method Purpose Response <code>/api/status</code> GET Health check Service status and timestamp <code>/api/config</code> GET Retrieve configuration Complete config object <code>/api/config</code> POST Update configuration Success/error with validation message <code>/api/config/backups</code> GET List backup files Array of backup filenames <code>/api/logs</code> GET Today's logs (smart RAM/Disk) Array of log strings (max 5000 lines, query: ?lines=N) <code>/api/logs/archive</code> GET List archived logs Array of archived log filenames <code>/api/logs/archive/&lt;filename&gt;</code> GET Retrieve specific archive Complete archived log content <code>/api/logs/archive/&lt;filename&gt;</code> DELETE Permanently delete archive Success/error confirmation <p>Request/Response Flow: - All responses use JSON format - Config updates validated before applying (required keys, value ranges) - Automatic backup created before each config modification - Errors return appropriate HTTP status codes (400, 403, 404, 500)</p> <p>Security Considerations: - No authentication currently implemented (relies on network isolation) - Path traversal protection in archive access endpoints - Filename validation to prevent arbitrary file access - Permanent deletion bypasses Windows recycle bin</p>"},{"location":"configuration/#configuration-structure","title":"Configuration Structure","text":""},{"location":"configuration/#file-structure","title":"File Structure","text":"<p>Configuration stored as encrypted file <code>cscf.dll</code> in application directory.</p> <p>Encryption Details: - Format: Fernet encrypted JSON string - Key: Derived from machine-specific hardware fingerprint via SecurityManager - Migration: Automatically converts legacy <code>config.json</code> to encrypted format - Backup: Encrypted backups stored in <code>config_backups/</code> subdirectory</p>"},{"location":"configuration/#configuration-schema","title":"Configuration Schema","text":"<pre><code>{\n  \"targets\": {\n    \"router\": \"192.168.1.1\",\n    \"server\": \"192.168.1.200\",\n    \"internet\": \"8.8.8.8\"\n  },\n  \"monitor_settings\": {\n    \"interval_seconds\": 2,\n    \"pc_subnet\": \"192.168.1\",\n    \"pc_start_range\": 110,\n    \"pc_count\": 20\n  },\n  \"verification_settings\": {\n    \"retry_delay_seconds\": 1.0,\n    \"secondary_target\": \"1.1.1.1\",\n    \"min_incident_duration_seconds\": 10\n  },\n  \"screenshot_settings\": {\n    \"enabled\": true,\n    \"interval_minutes\": 60,\n    \"quality\": 80,\n    \"resize_ratio\": 1.0\n  },\n  \"occupancy_settings\": {\n    \"enabled\": true,\n    \"mode\": \"session\",\n    \"min_session_minutes\": 3,\n    \"batch_delay_seconds\": 30,\n    \"hourly_snapshot_enabled\": true\n  },\n  \"discord_settings\": {\n    \"enabled\": false,\n    \"shop_name\": \"My Internet Cafe\",\n    \"webhook_alerts\": \"\",\n    \"webhook_occupancy\": \"\",\n    \"webhook_screenshots\": \"\"\n  },\n  \"system_settings\": {\n    \"env_state\": false,\n    \"log_retention_days\": 30\n  }\n}\n</code></pre>"},{"location":"configuration/#configuration-access-methods","title":"Configuration Access Methods","text":"<p>Remote Configuration (via API): - CafeSentinel-Manager application connects to Flask API - Sends POST request to <code>/api/config</code> with complete config object - ConfigManager validates, backs up, encrypts, and saves - Hot-reload mechanism detects change and applies within 2 seconds</p> <p>Local Configuration (via Settings Dialog): - Accessible from system tray context menu - Requires admin password for access - Four-tab interface: Network, Monitoring, Discord, System - Saves via same ConfigManager.update_config() method as API - Changes apply immediately via hot-reload</p>"},{"location":"configuration/#validation-rules","title":"Validation Rules","text":"<ul> <li>Screenshot interval: 1-1440 minutes</li> <li>Screenshot quality: 1-100</li> <li>Monitor interval: 1-60 seconds</li> <li>Log retention: 1-365 days</li> <li>All required sections must be present</li> <li>Invalid configurations rejected with error message</li> </ul>"},{"location":"configuration/#backup-system","title":"Backup System","text":"<ul> <li>Automatic backup before each configuration update</li> <li>Filename format: <code>backup_YYYYMMDD_HHMMSS.cscf.dll</code></li> <li>Stored in <code>config_backups/</code> subdirectory</li> <li>Backups are encrypted with same method as main config</li> <li>Automatic cleanup: keeps last 10 backups, deletes older</li> </ul>"},{"location":"configuration/#hot-reload-implementation","title":"Hot-Reload Implementation","text":"<p>Configuration changes apply without application restart through two mechanisms:</p> <p>Mechanism 1: Qt Signals (Same-Thread) - ConfigManager emits <code>sig_config_changed</code> signal when config updates - GUI components connected to this signal update immediately - Used for components running in main Qt thread (e.g., SystemTrayController for Stealth Mode updates)</p> <p>Mechanism 2: Dirty Flag Polling (Cross-Thread) - Worker thread polls ConfigManager.check_and_clear_dirty() each cycle - When flag is True, worker fetches fresh config and reinitializes - Thread-safe operation using internal lock - Used because Qt signals don't work reliably across threads</p> <p>Update Propagation: 1. Config update arrives (API or local settings) 2. ConfigManager validates and saves encrypted config 3. Sets internal dirty flag to True 4. Emits Qt signal to same-thread listeners 5. Worker thread detects dirty flag on next cycle 6. Worker reloads config and updates submodules 7. Changes take effect within 2 seconds</p>"},{"location":"deployment/","title":"Deployment &amp; Build","text":""},{"location":"deployment/#build-system","title":"Build System","text":""},{"location":"deployment/#compilation-process","title":"Compilation Process","text":"<p>Uses Nuitka to compile Python source to native Windows executable.</p> <p>Build Script: <code>build.py</code></p> <p>Build Modes:</p> <p>Fast Mode: - No LTO (Link Time Optimization) - Console window visible for debugging - Faster compilation (minutes vs hours) - Larger executable size - Used during development</p> <p>Production Mode: - Enables LTO for optimization - Console window hidden - Slower compilation (1-2 hours) - Smaller executable, faster runtime - Used for deployment</p> <p>Build Process: 1. Compile Qt resource file (<code>resources.qrc</code>) to <code>resources_rc.py</code> 2. Run Nuitka on <code>interface.py</code> to create CafeSentinel.exe 3. Run Nuitka on <code>watchdog_service.py</code> to create SentinelService.exe 4. Create nested folder structure for deployment 5. Copy both executables and support files to output directory</p>"},{"location":"deployment/#deployment-structure","title":"Deployment Structure","text":"<pre><code>dist/CafeSentinelDeploy/CafeSentinel/\n\u251c\u2500\u2500 CafeSentinel.exe              # Main application\n\u251c\u2500\u2500 install_monitor.bat           # Startup registration script\n\u2514\u2500\u2500 SentinelService/\n    \u2514\u2500\u2500 SentinelService.exe       # Watchdog process\n</code></pre> <p>Generated at Runtime: - <code>cscf.dll</code> (encrypted config) - <code>cron.dll</code> (encrypted passwords) - <code>info.log</code> (current day log) - <code>probes/</code> (archived logs with retention cleanup) - <code>config_backups/</code> (encrypted config backups)</p>"},{"location":"deployment/#nuitka-configuration","title":"Nuitka Configuration","text":"<p>Key compilation flags: - <code>--standalone</code>: Includes all dependencies - <code>--onefile</code>: Single executable (or separate for two processes) - <code>--windows-disable-console</code>: Hides console in production - <code>--enable-plugin=pyside6</code>: Bundles PySide6 framework - <code>--lto=yes</code>: Link Time Optimization (production only)</p>"},{"location":"deployment/#startup-registration","title":"Startup Registration","text":""},{"location":"deployment/#automatic-startup","title":"Automatic Startup","text":"<p>install_monitor.bat: - Registers SentinelService.exe in Windows Task Scheduler - Configured to run at user logon - Runs with highest privileges (admin) - Persistent across reboots</p> <p>Task Scheduler Configuration: - Trigger: At logon of specific user - Action: Start program (SentinelService.exe) - Run with highest privileges: Enabled - Run whether user is logged on or not: Enabled</p> <p>Startup Sequence: 1. Windows boots 2. User logs in 3. Task Scheduler starts SentinelService.exe (watchdog) 4. Watchdog detects CafeSentinel.exe not running 5. Watchdog launches CafeSentinel.exe 6. Main application starts monitoring and initializes logging system 7. Log retention cleanup executes on startup 8. Both processes enter mutual monitoring loop</p>"},{"location":"deployment/#alternative-methods","title":"Alternative Methods","text":"<p>Registry Run Key (Optional): - Add SentinelService.exe to <code>HKEY_CURRENT_USER\\Software\\Microsoft\\Windows\\CurrentVersion\\Run</code> - Starts at user logon without Task Scheduler - Less reliable for admin privileges</p> <p>Manual Execution: - User double-clicks SentinelService.exe - Watchdog starts and launches main application - Requires manual intervention after each reboot</p>"},{"location":"deployment/#dependencies","title":"Dependencies","text":""},{"location":"deployment/#python-packages","title":"Python Packages","text":"<p>Core Framework: - <code>PySide6</code> (6.x): Qt framework for GUI, threading, signals - <code>requests</code> (2.x): HTTP client for Discord webhooks and API client</p> <p>Monitoring: - <code>mss</code> (9.x): Multi-monitor screenshot capture library - <code>Pillow</code> (10.x): Image processing for screenshot resizing and format conversion</p> <p>Server: - <code>Flask</code> (3.x): REST API web framework - <code>flask-cors</code> (4.x): Cross-Origin Resource Sharing support</p> <p>Security: - <code>cryptography</code> (41.x): Fernet encryption for config and password vault</p>"},{"location":"deployment/#build-dependencies","title":"Build Dependencies","text":"<ul> <li><code>Nuitka</code> (1.8.x): Python to C compiler</li> <li><code>zstandard</code>: Compression library for Nuitka</li> <li><code>ordered-set</code>: Nuitka internal dependency</li> </ul>"},{"location":"deployment/#system-requirements","title":"System Requirements","text":"<p>Operating System: - Windows 10 or Windows 11 - 64-bit architecture required</p> <p>Privileges: - Administrator rights mandatory - Required for raw ICMP sockets - Auto-elevation on startup if not running as admin</p> <p>Runtime: - Python 3.10+ (for development) - Compiled executable requires no Python installation</p> <p>Network: - Local network connectivity for PC monitoring - Internet access for Discord notifications (optional) - Open port 5000 for API server (for Manager connectivity)</p>"},{"location":"deployment/#resource-management","title":"Resource Management","text":""},{"location":"deployment/#path-resolution","title":"Path Resolution","text":"<p>ResourceManager (utils/resource_manager.py):</p> <p>Handles path differences between script mode and compiled executable.</p> <p>Detection Logic: - Checks for <code>sys.frozen</code> attribute (PyInstaller) - Checks for <code>__compiled__</code> module (Nuitka) - Returns appropriate base directory based on mode</p> <p>Path Resolution: - Script mode: Returns script file directory - Compiled mode: Returns executable directory - Ensures config, logs, and other files written to correct location</p> <p>Usage Pattern:</p> <pre><code>config_path = ResourceManager.get_resource_path(\"cscf.dll\")\nlog_path = ResourceManager.get_resource_path(\"info.log\")\n</code></pre> <p>All file operations in application use ResourceManager for path resolution.</p>"},{"location":"features/","title":"Features &amp; UI","text":""},{"location":"features/#screenshot-system","title":"Screenshot System","text":""},{"location":"features/#capture-process","title":"Capture Process","text":"<p>Captures primary monitor using mss library with post-processing.</p> <p>Capture Pipeline: 1. Identify primary monitor via mss.mss() 2. Capture raw pixels to memory 3. Convert to PIL Image object 4. Resize according to <code>resize_ratio</code> setting (1.0 = original, 0.5 = half size) 5. Compress to WebP format with configured quality (1-100) 6. Store in memory buffer (not saved to disk) 7. Send directly to Discord webhook as file attachment</p> <p>WebP Format Benefits: - Better compression than JPEG at equivalent quality - Smaller file sizes reduce upload time and Discord storage - Maintains transparency support (though not used currently)</p>"},{"location":"features/#asynchronous-uploads","title":"Asynchronous Uploads","text":"<p>Routine and incident screenshots are now uploaded asynchronously using background threads so that the main monitoring loop never blocks on HTTP network operations. The worker captures the image in the main thread (fast, &lt;100ms), then hands the in\u2011memory WebP bytes to a dedicated upload thread that sends the data to Discord webhooks (slow, 2-5 seconds). If capture fails and no image data is produced, an error log entry is written instead of silently skipping the upload.</p> <p>Benefits: - Prevents monitoring delays during Discord uploads - Eliminates \"Slow Scan Loop\" warnings caused by screenshot uploads - Maintains consistent 2-second monitoring interval even during network congestion - Failed captures are now logged for troubleshooting (e.g., monitor turned off)</p> <p>Example Logs:</p> <pre><code>[2025-12-09 19:28:28] [TASK] Capturing Routine Screenshot (1m)\n[2025-12-09 19:29:29] [TASK] Capturing Routine Screenshot (1m)\n[2025-12-09 19:30:15] [ERROR] Screenshot Capture Failed: No image data returned (Monitor off?)\n[2025-12-09 19:35:00] [ERROR] Incident Screenshot Failed: No image data returned\n</code></pre>"},{"location":"features/#capture-triggers","title":"Capture Triggers","text":"<p>Routine Scheduled Capture: - Interval set via <code>screenshot_settings.interval_minutes</code> - Timer tracks time since last capture - Triggers when interval elapsed - Continues until disabled or privacy mode enabled</p> <p>Incident Documentation: - Automatically captured when network outage resolves - Provides visual evidence of recovery time - Includes network status in Discord embed - Helps diagnose issues visible on client screens</p> <p>Privacy Mode: - Toggle via privacy password from system tray - Disables all screenshot capture when active - Routine and incident captures both blocked - Visual indicator in system tray when enabled</p>"},{"location":"features/#settings","title":"Settings","text":"<ul> <li>Enabled: Master toggle for screenshot system</li> <li>Interval: Minutes between routine captures (1-1440)</li> <li>Quality: WebP compression quality (1-100, higher = better quality/larger file)</li> <li>Resize Ratio: Scale factor (1.0 = full size, 0.5 = half dimensions, 0.25 = quarter)</li> </ul>"},{"location":"features/#discord-upload","title":"Discord Upload","text":"<p>Screenshots sent to Discord via webhook with rich embed.</p> <p>Upload Process: 1. Image data in memory buffer 2. Background thread performs HTTP POST to webhook URL with multipart/form-data 3. Embed includes: timestamp, shop name, trigger type 4. File attachment: <code>screenshot.webp</code> 5. Color coding: blue (routine), green (incident recovery)</p>"},{"location":"features/#discord-integration","title":"Discord Integration","text":""},{"location":"features/#webhook-configuration","title":"Webhook Configuration","text":"<p>Three separate webhook URLs for different notification types.</p> <p>Webhook Types: - Alerts: Network outages and restorations - Occupancy: PC session starts/ends, hourly snapshots - Screenshots: Routine and incident captures</p> <p>Configuration: - URLs stored encrypted in <code>cscf.dll</code> - Each webhook can point to different channel or same channel - Webhooks optional (system works without Discord notifications)\\ - Invalid/missing webhooks logged but do not crash application</p>"},{"location":"features/#notification-format","title":"Notification Format","text":"<p>All Discord messages use rich embeds with structured data.</p> <p>Embed Components: - Title: Event description (e.g., \"Router Outage Resolved\") - Description: Detailed information and timestamps - Color: Visual coding (red = outage, green = recovery, blue = routine) - Footer: Shop name and system identifier - Timestamp: ISO 8601 format for accurate timing - Fields: Structured key-value pairs for duration, affected systems, etc.</p> <p>Alert Examples:</p> <p>Router Outage:</p> <pre><code>Title: Router Connection Lost\nColor: Red\nDescription: Connectivity to router lost at [timestamp]\nFields: Duration (when resolved), Verification attempts\n</code></pre> <p>PC Session Start:</p> <pre><code>Title: Client PC Online\nColor: Green  \nDescription: PC [IP] came online\nFields: Timestamp, Total active PCs\n</code></pre> <p>Hourly Snapshot:</p> <pre><code>Title: Occupancy Report\nColor: Blue\nDescription: Current occupancy status\nFields: Active PCs, Percentage occupied, Peak today\n</code></pre>"},{"location":"features/#notification-batching","title":"Notification Batching","text":"<p>SessionManager batches occupancy notifications to avoid spam.</p> <p>Batching Rules: - Multiple state changes within batch delay window grouped together - Single notification sent after delay expires - Includes count of affected PCs - Reduces notification volume during busy periods (e.g., opening/closing time)</p> <p>Configuration: - <code>batch_delay_seconds</code>: Time window for batching (default 30) - Balance between responsiveness and notification volume - Set to 1 for immediate individual notifications - Set to 300 (5 minutes) for heavily batched reports</p>"},{"location":"features/#local-settings-dialog","title":"Local Settings Dialog","text":""},{"location":"features/#overview","title":"Overview","text":"<p>Password-protected GUI for on-site configuration without Manager application.</p> <p>Access Method: - Right-click any system tray icon - Select \"Settings\" from context menu - Enter admin password - Settings dialog opens</p> <p>Purpose: - Emergency configuration changes when Manager unavailable - On-site adjustments by authorized personnel - No remote network connection required - Uses same ConfigManager as API (changes synchronized)</p>"},{"location":"features/#interface-structure","title":"Interface Structure","text":"<p>Four-tab layout covering all configuration sections.</p> <p>Network Tab: - Network Targets: Router IP, Server IP, Internet test IP - Verification Settings: Retry delay, Secondary DNS, Min incident duration</p> <p>Monitoring Tab: - Scan Settings: Check interval, PC subnet, PC start range, PC count - Screenshots: Enable toggle, Interval, Quality, Resize ratio - Occupancy: Enable toggle, Hourly snapshots, Min session duration, Batch delay</p> <p>Discord Tab: - Enable toggle for notifications - Shop name for embed footers - Three webhook URLs: Alerts, Occupancy, Screenshots</p> <p>System Tab: - Stealth Mode: Enable/disable system tray icons - Log Retention: Days to keep archived logs (1-365)</p>"},{"location":"features/#save-process","title":"Save Process","text":"<ol> <li>User modifies settings in form fields</li> <li>Clicks \"Save Changes\" button</li> <li>Form data collected into config dictionary</li> <li>ConfigManager validates configuration</li> <li>If valid: Encrypt, save to <code>cscf.dll</code>, trigger hot-reload</li> <li>If invalid: Display error message, prevent save</li> <li>Success dialog confirms changes applied</li> <li>Changes take effect within 2 seconds</li> </ol>"},{"location":"features/#security","title":"Security","text":"<ul> <li>Admin password required for access</li> <li>Password verified via SecurityManager before opening dialog</li> <li>Incorrect password displays \"Access Denied\" message</li> <li>Dialog remains open until user closes (no timeout)</li> <li>Changes logged but no sensitive data included in logs</li> </ul>"},{"location":"features/#system-tray-controller","title":"System Tray Controller","text":"<p>Stealth Mode (Headless Operation): - Implementation: Configurable via <code>env_state</code> boolean in <code>system_settings</code>. - Behavior:   - Enabled (<code>True</code>): Application runs normally but hides all system tray icons.   - Disabled (<code>False</code>): Standard system tray icons are visible. - Persistence: App is configured with <code>setQuitOnLastWindowClosed(False)</code> to ensure the process continues running even without visible UI elements. - Toggle Mechanism: Can be toggled remotely via API (Manager App) or locally via Settings Dialog (if accessible). Updates apply immediately via hot-reload.</p> <p>System Tray Icons: - Router: green (online) / red (offline) - Server: green (online) / red (offline) - Internet: green (online) / red (offline) - Clients: displays active PC count with dynamic icon generation</p>"},{"location":"logging/","title":"Logging System","text":""},{"location":"logging/#architecture","title":"Architecture","text":"<p>Professional 4-phase logging system with rotation, retention, and structured categorization.</p> <p>Active Log: - File: <code>info.log</code> (current day only) - Updated continuously during application runtime - Contains only today's activity - Automatically rotated at midnight or when size exceeds 5MB - Served via API for real-time monitoring</p> <p>Archive: - Directory: <code>probes/</code> subdirectory - Contains historical logs from previous days - Files automatically deleted based on retention policy - Organized by date: <code>info-YYYY-MM-DD.log</code> - Manual deletion also available via API</p> <p>Memory Buffer: - In-memory circular buffer of last 500 log lines - Used for fast API serving without disk I/O - Populated as logs are written - Provides real-time log access to Manager application</p>"},{"location":"logging/#log-rotation","title":"Log Rotation","text":"<p>Daily Rotation: - Occurs at midnight when date changes - On application startup if date changed while offline - Current <code>info.log</code> renamed to <code>probes/info-YYYY-MM-DD.log</code> - Fresh <code>info.log</code> created for new day - No data loss during rotation process</p> <p>Size-Based Rotation: - Triggered when <code>info.log</code> exceeds 5MB - File moved to <code>probes/info-YYYY-MM-DD-HHMMSS.log</code> - Fresh <code>info.log</code> created immediately - Part number appended if multiple rotations same day - Prevents runaway log growth from error loops</p> <p>Rotation Process: 1. AppLogger detects rotation condition (date change or size limit) 2. Current <code>info.log</code> renamed with timestamp 3. Moved to <code>probes/</code> archive directory 4. New empty <code>info.log</code> created 5. Logging continues without interruption 6. Rotation event logged in new file</p>"},{"location":"logging/#log-retention-cleanup","title":"Log Retention &amp; Cleanup","text":"<p>Automatic Cleanup: - Configurable retention period via <code>log_retention_days</code> setting (default: 30 days) - Cleanup executes automatically on application startup - Files in <code>probes/</code> folder older than retention period permanently deleted - Deletion bypasses Windows recycle bin (immediate destruction) - Cleanup event logged with count of deleted files</p> <p>Retention Configuration: - Located in <code>system_settings.log_retention_days</code> - Range: 1-365 days recommended - Default: 30 days - Configurable via Settings Dialog (System tab) or API - Changes take effect on next application restart</p> <p>Cleanup Process: 1. Application starts, reads <code>log_retention_days</code> from config 2. AppLogger.initialize() called by SystemTrayController 3. AppLogger.cleanup_old_logs() executes 4. Scans <code>probes/</code> directory for .log files 5. Checks file modification timestamp against cutoff date 6. Deletes files older than retention period 7. Logs cleanup summary to current day log</p> <p>Example Cleanup Log:</p> <pre><code>[2025-12-09 17:00:00] [LOGGER] Cleaned up 15 old log files (Retention: 30 days)\n</code></pre>"},{"location":"logging/#log-format","title":"Log Format","text":"<p>Each log line follows structured categorized format:</p> <pre><code>[YYYY-MM-DD HH:MM:SS] [CATEGORY] Message text\n</code></pre> <p>Components: - Timestamp: Full date and time in 24-hour format, local timezone - Category: Structured tag for filtering and color-coding - Message: Sanitized text without sensitive file paths or internal structure details</p> <p>Standard Categories:</p> Category Usage <code>SYSTEM</code> Application startup, shutdown, initialization, API server events, configuration snapshots <code>CONFIG</code> Configuration loading, saving, validation, hot-reload events <code>NETWORK</code> Network scanning, connectivity checks, target validation, jitter detection <code>ALERT</code> Network outages, failures, incidents started <code>RECOVERY</code> Network restoration, incident resolution <code>DISCORD</code> Discord webhook notifications, delivery status <code>DAEMON</code> Monitoring loop lifecycle events <code>TASK</code> Scheduled tasks (screenshots, snapshots) <code>SETTINGS</code> Settings dialog operations, local configuration changes <code>STEALTH</code> Stealth mode toggle events <code>LOGGER</code> Log rotation, retention cleanup, archive operations <code>WATCHDOG</code> Watchdog process lifecycle events, exit code interpretation, restart operations <code>ERROR</code> Exceptions, failures, error conditions <code>ARCHIVE</code> Archive file operations (API deletion, retrieval) <p>Example Log Lines:</p> <pre><code>[2025-12-09 05:23:15] [SYSTEM] Kernel thread attached (Singleton Mode)\n[2025-12-09 05:23:15] [SYSTEM] Settings Loaded: Interval=2s, Targets=100 PCs\n[2025-12-09 05:23:16] [CONFIG] Updated successfully\n[2025-12-09 05:23:45] [ALERT] Router DOWN | Timer Started\n[2025-12-09 05:23:50] [NETWORK] Router jitter detected (4.2s) - Below threshold (10s).\n[2025-12-09 05:24:12] [RECOVERY] Router Restored | Duration: 0:00:27\n[2025-12-09 05:25:00] [TASK] Capturing Routine Screenshot (60m)\n[2025-12-09 05:25:01] [ERROR] Screenshot Capture Failed: No image data returned (Monitor off?)\n[2025-12-09 06:00:00] [LOGGER] Cleaned up 5 old log files (Retention: 30 days)\n[2025-12-09 08:30:15] [STEALTH] Entering Stealth Mode. Tray icons hidden.\n[2025-12-09 19:00:01] [WATCHDOG] Starting CafeSentinel process (spawn mode).\n[2025-12-09 19:00:03] [WATCHDOG] CafeSentinel exited cleanly (Code 0). Stopping watchdog.\n</code></pre>"},{"location":"logging/#smart-api-log-serving","title":"Smart API Log Serving","text":"<p>Intelligent Serving Strategy: - API endpoint <code>/api/logs</code> uses smart switching based on request size - Requests \u2264500 lines: Served from memory buffer (fast, no disk I/O) - Requests &gt;500 lines: Read from disk <code>info.log</code> (complete history) - Provides optimal balance between speed and visibility</p> <p>Memory Buffer Serving (Fast Path): - Query: <code>GET /api/logs?lines=200</code> - Source: In-memory circular buffer (last 500 lines) - Response time: &lt;10ms - Use case: Real-time monitoring, live log tail</p> <p>Disk Serving (Deep History): - Query: <code>GET /api/logs?lines=2000</code> - Source: Current day <code>info.log</code> file on disk - Response time: 50-200ms depending on file size - Use case: Complete daily history, incident investigation</p> <p>Query Parameters: - <code>?lines=N</code>: Request N lines (default: 500, min: 10, max: 5000) - Clamped to safe range to prevent excessive memory usage - Returns actual line count in response (may be less than requested)</p> <p>Response Format:</p> <pre><code>{\n  \"status\": \"success\",\n  \"lines\": 2000,\n  \"source\": \"disk\",\n  \"logs\": [\"...\"]\n}\n</code></pre> <p>Fallback Behavior: - If disk read fails, automatically falls back to memory buffer - Errors logged but service continues - Manager application always receives some data</p>"},{"location":"logging/#api-access","title":"API Access","text":"<p>Real-Time Logs (GET /api/logs): - Returns today's log lines with smart RAM/Disk switching - Query parameter: <code>?lines=500</code> (default 500, max 5000) - Fast response for small requests (&lt;500 lines) - Complete history for large requests (&gt;500 lines) - Used by Manager for live monitoring and history review</p> <p>Archive List (GET /api/logs/archive): - Returns array of archived log filenames - Sorted newest first - Filenames only (content not included) - Used by Manager for archive browser</p> <p>Archive Retrieval (GET /api/logs/archive/): - Returns complete content of specific archived log - Filename from archive list - Path traversal protection enforced - Used by Manager to view historical logs <p>Archive Deletion (DELETE /api/logs/archive/): - Permanently deletes archived log file - No recycle bin, immediate destruction - Requires exact filename from archive list - Returns error if file in use or not found - Security: Only allows deletion of files matching <code>info-*.log</code> pattern"},{"location":"monitoring/","title":"Network Monitoring System","text":""},{"location":"monitoring/#core-components","title":"Core Components","text":""},{"location":"monitoring/#sentinelworker-modelssentinel_workerpy","title":"SentinelWorker (models/sentinel_worker.py)","text":"<p>Main monitoring thread that performs continuous network surveillance.</p> <p>Responsibilities: - Runs in separate QThread to avoid blocking GUI - Performs network scans every N seconds (configurable, default 2 seconds) - Manages screenshot scheduling based on interval settings - Coordinates with SessionManager for PC occupancy tracking - Emits Qt signals to update system tray icons and GUI - Implements hot-reload configuration updates without restart</p> <p>Hot-Reload Mechanism: - Worker polls ConfigManager's dirty flag each monitoring cycle - When flag is set (config updated via API or local settings), worker reloads configuration - Updates internal state variables and reinitializes submodules - Changes take effect within 2 seconds without application restart - Uses thread-safe polling to avoid cross-thread signal issues</p> <p>Monitoring Loop: 1. Check config dirty flag and reload if needed 2. Scan network targets (router, server, internet) 3. Scan PC range for occupancy tracking 4. Process state changes and trigger notifications 5. Handle routine screenshot capture if interval elapsed 6. Sleep for configured interval and repeat</p>"},{"location":"monitoring/#startup-configuration-snapshot","title":"Startup Configuration Snapshot","text":"<p>On monitoring start, the worker logs a concise snapshot of its active configuration, including the monitoring interval in seconds and the number of PC targets in the current scan range. This <code>[SYSTEM]</code> log entry appears once per process start and helps correlate historical logs with the exact runtime settings that were in effect at the time (for example, changes to scan interval or PC count).</p> <p>Example Log:</p> <pre><code>[2025-12-09 19:27:28] [SYSTEM] Settings Loaded: Interval=2s, Targets=100 PCs\n</code></pre>"},{"location":"monitoring/#sentinelserviceexe-watchdog","title":"SentinelService.exe (Watchdog)","text":"<p>Monitors the main CafeSentinel application and ensures continuous operation.</p> <p>Core Responsibilities: - Detects when CafeSentinel.exe terminates - Automatically restarts the main application on unexpected termination - Runs with elevated admin privileges - Operates independently of the main application</p>"},{"location":"monitoring/#process-lifecycle-logging","title":"Process Lifecycle Logging","text":"<p>The watchdog now writes lightweight lifecycle events directly to the main <code>info.log</code> file using a raw append strategy instead of the primary logging class. Each time the main application is started, stopped, or restarted, a <code>[WATCHDOG]</code> log line is emitted with a timestamp and description of the event.</p> <p>Exit codes are interpreted to distinguish user\u2011initiated shutdowns from abnormal terminations. A clean exit (<code>code 0</code>) and setup cancellation (<code>code 100</code>) are logged as intentional stops, and the watchdog terminates itself without relaunching the main app. Any other non\u2011zero exit code is treated as an unexpected termination, logged with the code value, and triggers an automatic restart after a short delay.</p> <p>Exit Code Behavior: - Code 0 (Clean Exit): User closed the app intentionally with admin password \u2192 Watchdog stops, no restart - Code 100 (Setup Cancelled): User cancelled first-run setup \u2192 Watchdog stops, no restart - Other Codes: Application crashed or was forcibly terminated \u2192 Watchdog logs the exit code and restarts the app after 2 seconds</p> <p>Example Logs:</p> <pre><code>[2025-12-09 19:00:01] [WATCHDOG] Starting CafeSentinel process (spawn mode).\n[2025-12-09 19:00:03] [WATCHDOG] CafeSentinel exited cleanly (Code 0). Stopping watchdog.\n[2025-12-09 19:15:22] [WATCHDOG] CafeSentinel terminated unexpectedly (Exit Code -1073741819). Restarting...\n</code></pre>"},{"location":"monitoring/#network-monitoring","title":"Network Monitoring","text":""},{"location":"monitoring/#ping-implementation","title":"Ping Implementation","text":"<p>Uses raw ICMP sockets implemented in <code>network_tools.py</code>.</p> <p>Technical Details: - Creates raw ICMP Echo Request packets - Requires administrator privileges (raw socket access) - Concurrent scanning using multithreading - Default timeout: 1 second per host - Returns list of responsive IP addresses</p> <p>Scan Targets: - Router: Local network gateway - Server: Internet cafe server or critical infrastructure - Internet: Public DNS (default 8.8.8.8) - PC Range: All client computers in configured subnet</p>"},{"location":"monitoring/#verification-logic","title":"Verification Logic","text":"<p>Multi-stage verification prevents false positive alerts.</p> <p>Internet Verification: 1. Primary target fails (e.g., 8.8.8.8) 2. Wait configured retry delay (default 1 second) 3. Test secondary target (default 1.1.1.1) 4. If both fail, declare internet outage 5. If either succeeds, no alert generated</p> <p>Incident Duration Filter: - Initial failure starts incident timer - Continuous monitoring during incident - Alert generated only if outage exceeds minimum duration - Default minimum: 10 seconds - Prevents alerts for momentary network glitches</p> <p>Cascading Failure Detection: - If router fails, expect server and internet to also fail - If only internet fails, router/server failures ignored - Distinguishes local network issues from ISP problems - Reduces notification spam during major outages</p>"},{"location":"monitoring/#jitter-visibility-below-incident-threshold","title":"Jitter Visibility Below Incident Threshold","text":"<p>Short\u2011lived connectivity drops that recover before the configured <code>min_incident_duration_seconds</code> are now explicitly logged as jitter events instead of being silently ignored. When a component such as the router, server, or ISP target goes down and then recovers within this threshold, the system records a <code>[NETWORK]</code> log entry indicating the affected component and the exact outage duration, while still suppressing full incident creation and Discord alerts. This provides visibility into unstable links without generating alert noise.</p> <p>Example Jitter Logs:</p> <pre><code>[2025-12-09 14:22:10] [ALERT] ISP DOWN | Timer Started\n[2025-12-09 14:22:14] [NETWORK] ISP jitter detected (3.8s) - Below threshold (10s).\\\n[2025-12-09 15:45:30] [ALERT] Router DOWN | Timer Started\\\n[2025-12-09 15:45:36] [NETWORK] Router jitter detected (5.2s) - Below threshold (10s).\\\n</code></pre> <p>Benefits: - Reveals intermittent network instability that doesn't trigger full outages - Helps identify degraded ISP service quality - Provides data for troubleshooting connectivity issues - Logs can be used as evidence when reporting issues to ISPs</p>"},{"location":"monitoring/#pc-occupancy-tracking","title":"PC Occupancy Tracking","text":"<p>Monitors range of client PCs for online/offline state.</p> <p>IP Range Generation: - Base subnet: <code>pc_subnet</code> setting (e.g., \"192.168.1\") - Start IP: <code>pc_start_range</code> setting (e.g., 110) - Count: <code>pc_count</code> setting (e.g., 20) - Generates: 192.168.1.110 through 192.168.1.129</p> <p>State Change Detection: 1. Ping all IPs in range each monitoring cycle 2. Compare results to previous cycle state 3. Detect transitions: offline\u2192online (session start), online\u2192offline (session end) 4. Pass changes to SessionManager for processing</p> <p>SessionManager Processing: - Applies stability period to confirm state change - Filters out sessions shorter than minimum duration - Batches multiple changes to avoid notification spam - Freezes state during network outages - Triggers Discord notifications for confirmed changes</p>"},{"location":"security/","title":"Security System","text":""},{"location":"security/#encryption-architecture","title":"Encryption Architecture","text":"<p>All sensitive data encrypted using Fernet symmetric encryption from cryptography library.</p> <p>Machine-Specific Key Generation: - SecurityManager generates key from hardware fingerprint - Uses motherboard serial number and processor ID (Windows WMI) - SHA-256 hash converted to base64 for Fernet compatibility - Key never stored on disk, regenerated on each application start - Config encrypted on one machine cannot be decrypted on another</p> <p>File Disguising Strategy: - Configuration: <code>cscf.dll</code> (not <code>config.json</code>) - Password vault: <code>cron.dll</code> (not <code>passwords.json</code>) - Backups: <code>backup_TIMESTAMP.cscf.dll</code>  - Appears as system library files to casual inspection - Prevents easy identification of sensitive data</p>"},{"location":"security/#password-management","title":"Password Management","text":""},{"location":"security/#securitymanager-modelssecurity_managerpy","title":"SecurityManager (models/security_manager.py)","text":"<p>Manages two password types stored in encrypted vault file <code>cron.dll</code>.</p> <p>Password Types: - Admin Password: Required for application exit and settings access - Privacy Password: Required to toggle screenshot capture mode</p> <p>Vault Structure: - Single encrypted file containing both passwords - Fernet encryption with machine-specific key - Created during first-run setup wizard - Passwords stored as bcrypt hashes (not plaintext)</p> <p>First-Run Setup: - Application detects missing <code>cron.dll</code> vault file - Displays setup wizard requiring both passwords - Validates password strength (minimum length, confirmation match) - Creates encrypted vault with hashed passwords - Application cannot start without completing setup</p> <p>Password Verification Flow: 1. User enters password in dialog 2. SecurityManager loads and decrypts vault 3. Compares input against stored bcrypt hash 4. Returns boolean verification result 5. Application grants or denies access</p>"},{"location":"security/#log-sanitization","title":"Log Sanitization","text":"<p>All log messages sanitized to prevent information disclosure.</p> <p>Sanitization Rules: - Never log file paths or filenames - Use generic category labels: SYSTEM, CONFIG, NETWORK, etc. - Error messages omit exception details that reveal structure - Success messages confirm action without specifics - Example: \"[CONFIG] Updated successfully\" not \"[CONFIG] Saved to cscf.dll\"</p> <p>Purpose: - Prevents attackers from identifying critical files - Obscures application architecture from log analysis - Reduces attack surface by limiting exposed information</p>"},{"location":"security/#admin-requirements","title":"Admin Requirements","text":"<ul> <li>Application requires administrator privileges to run</li> <li>Required for raw ICMP socket creation (network monitoring)</li> <li>Self-elevates on startup if not running as admin</li> <li>Watchdog service also runs with elevated privileges</li> <li>API server inherits admin privileges from main process</li> </ul>"}]}